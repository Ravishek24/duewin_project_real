# PlayWin6 Models and Database Setup

This document provides comprehensive information about the PlayWin6 database models, their structure, and how to set up the database tables.

## üìã Table of Contents

1. [Model Files Created](#model-files-created)
2. [Database Tables](#database-tables)
3. [SQL Commands](#sql-commands)
4. [Migration File](#migration-file)
5. [Model Associations](#model-associations)
6. [Database Setup Instructions](#database-setup-instructions)
7. [Model Features](#model-features)
8. [Usage Examples](#usage-examples)

## üóÇÔ∏è Model Files Created

### 1. `Backend/models/PlayWin6GameSession.js`
- **Purpose**: Manages PlayWin6 game sessions
- **Key Features**:
  - Session lifecycle management (active, ended, expired, error)
  - Game metadata storage
  - Player credentials tracking
  - Platform and IP tracking
  - Session validation methods

### 2. `Backend/models/PlayWin6Transaction.js`
- **Purpose**: Manages PlayWin6 transactions (bets, wins, rollbacks, balance updates)
- **Key Features**:
  - Transaction type management
  - Balance tracking (old/new balance)
  - Callback data storage
  - Rollback support
  - Comprehensive indexing

## üóÑÔ∏è Database Tables

### 1. `playwin6_game_sessions`
Stores game session information including:
- Session tokens and launch tokens
- Game metadata (provider, game type, game ID)
- Player information (username, currency, language)
- Session status and lifecycle
- Platform and IP tracking
- Game URLs and metadata

### 2. `playwin6_transactions`
Stores transaction records including:
- Transaction types (bet, win, rollback, balance)
- Amount and currency information
- Balance tracking (before/after)
- Provider transaction IDs
- Callback data and encrypted payloads
- Rollback references

## üîß SQL Commands

### Direct SQL Execution
Run the following SQL commands in your MySQL database:

```sql
-- File: Backend/sql/create_playwin6_tables.sql

-- Create playwin6_game_sessions table
CREATE TABLE `playwin6_game_sessions` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `game_id` varchar(255) NOT NULL COMMENT 'PlayWin6 game identifier',
  `provider` varchar(255) NOT NULL COMMENT 'Game provider (e.g., JiliGaming, PragmaticPlay)',
  `game_type` varchar(255) NOT NULL COMMENT 'Type of game (Slot Game, Live Casino, etc.)',
  `launch_token` varchar(255) NOT NULL COMMENT 'Unique token for this game session launch',
  `session_token` varchar(255) DEFAULT NULL COMMENT 'Token generated by PlayWin6 for current game session',
  `player_username` varchar(255) NOT NULL COMMENT 'Player username for PlayWin6',
  `currency` varchar(10) NOT NULL DEFAULT 'INR' COMMENT 'Game currency',
  `language` varchar(10) NOT NULL DEFAULT 'en' COMMENT 'Game language',
  `platform` enum('mobile','desktop') NOT NULL DEFAULT 'desktop',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP address where session was created',
  `status` enum('active','ended','expired','error') NOT NULL DEFAULT 'active',
  `game_url` text DEFAULT NULL COMMENT 'Full game launch URL',
  `provider_url` text DEFAULT NULL COMMENT 'Provider game URL',
  `metadata` json DEFAULT NULL COMMENT 'Additional game metadata',
  `started_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `ended_at` datetime DEFAULT NULL,
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `launch_token` (`launch_token`),
  KEY `user_id` (`user_id`),
  KEY `session_token` (`session_token`),
  KEY `status` (`status`),
  KEY `game_id` (`game_id`),
  KEY `provider` (`provider`),
  KEY `created_at` (`created_at`),
  KEY `idx_user_game_active` (`user_id`,`game_id`,`status`),
  KEY `idx_provider_status` (`provider`,`status`),
  CONSTRAINT `playwin6_game_sessions_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='PlayWin6 game sessions';

-- Create playwin6_transactions table
CREATE TABLE `playwin6_transactions` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `user_id` int(11) NOT NULL,
  `session_id` int(11) NOT NULL,
  `type` enum('bet','win','rollback','balance') NOT NULL COMMENT 'Type of transaction',
  `amount` decimal(15,2) NOT NULL COMMENT 'Transaction amount',
  `currency` varchar(10) NOT NULL DEFAULT 'INR' COMMENT 'Transaction currency',
  `provider` varchar(255) NOT NULL COMMENT 'Game provider (e.g., JiliGaming, PragmaticPlay)',
  `game_id` varchar(255) NOT NULL COMMENT 'Game identifier',
  `game_uid` varchar(255) DEFAULT NULL COMMENT 'Game unique identifier from PlayWin6',
  `provider_tx_id` varchar(255) NOT NULL COMMENT 'Transaction ID from PlayWin6',
  `operator_tx_id` varchar(255) NOT NULL COMMENT 'Our internal transaction ID',
  `action` varchar(255) NOT NULL COMMENT 'Action type (bet, win, rollback, balance)',
  `action_id` varchar(255) DEFAULT NULL COMMENT 'Action identifier from game',
  `old_balance` decimal(15,2) NOT NULL COMMENT 'Balance before transaction',
  `new_balance` decimal(15,2) NOT NULL COMMENT 'Balance after transaction',
  `wallet_amount` decimal(15,2) DEFAULT NULL COMMENT 'Wallet amount from callback',
  `status` enum('pending','completed','failed','rolled_back') NOT NULL DEFAULT 'pending',
  `rollback_provider_tx_id` varchar(255) DEFAULT NULL COMMENT 'Reference to original transaction for rollbacks',
  `platform` enum('mobile','desktop') DEFAULT NULL COMMENT 'Platform where transaction occurred',
  `ip_address` varchar(45) DEFAULT NULL COMMENT 'IP address where transaction occurred',
  `callback_data` json DEFAULT NULL COMMENT 'Raw callback data from PlayWin6',
  `encrypted_payload` text DEFAULT NULL COMMENT 'Encrypted payload from PlayWin6',
  `timestamp` bigint(20) DEFAULT NULL COMMENT 'Timestamp from PlayWin6 callback',
  `token` varchar(255) DEFAULT NULL COMMENT 'Token from PlayWin6 callback',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `provider_tx_id` (`provider_tx_id`),
  UNIQUE KEY `operator_tx_id` (`operator_tx_id`),
  KEY `user_id` (`user_id`),
  KEY `session_id` (`session_id`),
  KEY `type` (`type`),
  KEY `status` (`status`),
  KEY `game_uid` (`game_uid`),
  KEY `created_at` (`created_at`),
  KEY `idx_rollback_provider_tx` (`rollback_provider_tx_id`),
  KEY `idx_session_type_status` (`session_id`,`type`,`status`),
  KEY `idx_game_uid_provider` (`game_uid`,`provider`),
  CONSTRAINT `playwin6_transactions_ibfk_1` FOREIGN KEY (`user_id`) REFERENCES `users` (`user_id`) ON DELETE CASCADE,
  CONSTRAINT `playwin6_transactions_ibfk_2` FOREIGN KEY (`session_id`) REFERENCES `playwin6_game_sessions` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='PlayWin6 transactions';

-- Additional performance indexes
CREATE INDEX `idx_playwin6_user_created` ON `playwin6_transactions` (`user_id`, `created_at`);
CREATE INDEX `idx_playwin6_provider_type` ON `playwin6_transactions` (`provider`, `type`);
CREATE INDEX `idx_playwin6_status_created` ON `playwin6_transactions` (`status`, `created_at`);
CREATE INDEX `idx_playwin6_session_created` ON `playwin6_game_sessions` (`session_token`, `created_at`);
CREATE INDEX `idx_playwin6_callback_timestamp` ON `playwin6_transactions` (`timestamp`, `status`);
```

## üîÑ Migration File

### File: `Backend/migrations/20241201000000-create-playwin6-tables.js`
- **Purpose**: Sequelize migration for creating PlayWin6 tables
- **Usage**: Run with `npx sequelize-cli db:migrate`
- **Features**:
  - Creates both tables with proper foreign key constraints
  - Adds comprehensive indexes for performance
  - Includes rollback functionality
  - Proper error handling and logging

## üîó Model Associations

### PlayWin6GameSession Associations
```javascript
// Belongs to User
this.belongsTo(models.User, {
  foreignKey: 'user_id',
  as: 'user'
});

// Has many PlayWin6Transaction
this.hasMany(models.PlayWin6Transaction, {
  foreignKey: 'session_id',
  as: 'transactions'
});
```

### PlayWin6Transaction Associations
```javascript
// Belongs to User
this.belongsTo(models.User, {
  foreignKey: 'user_id',
  as: 'user'
});

// Belongs to PlayWin6GameSession
this.belongsTo(models.PlayWin6GameSession, {
  foreignKey: 'session_id',
  as: 'session'
});
```

## üöÄ Database Setup Instructions

### Option 1: Using Sequelize Migration (Recommended)
```bash
# Navigate to Backend directory
cd Backend

# Run the migration
npx sequelize-cli db:migrate

# Verify tables were created
npx sequelize-cli db:migrate:status
```

### Option 2: Direct SQL Execution
```bash
# Connect to your MySQL database
mysql -u your_username -p your_database_name

# Execute the SQL file
source Backend/sql/create_playwin6_tables.sql
```

### Option 3: Using MySQL Workbench or phpMyAdmin
1. Open your MySQL client
2. Select your database
3. Execute the SQL commands from `Backend/sql/create_playwin6_tables.sql`

## ‚ú® Model Features

### PlayWin6GameSession Features
- **Session Validation**: `isValid()` method checks if session is still active
- **Duration Calculation**: `getDuration()` returns session duration in seconds
- **Status Management**: Methods to mark sessions as ended, expired, or error
- **Summary Generation**: `getSummary()` returns formatted session information

### PlayWin6Transaction Features
- **Transaction Types**: Support for bet, win, rollback, and balance transactions
- **Rollback Support**: `canRollback()` and `isRolledBack()` methods
- **Balance Tracking**: Tracks old and new balance for each transaction
- **Callback Data**: Stores raw callback data and encrypted payloads
- **Summary Methods**: `getSummary()` and `getCallbackSummary()` for formatted output

## üí° Usage Examples

### Creating a Game Session
```javascript
const { PlayWin6GameSession } = require('../models');

const session = await PlayWin6GameSession.create({
  user_id: 123,
  game_id: 'slot_game_001',
  provider: 'JiliGaming',
  game_type: 'Slot Game',
  launch_token: 'unique_launch_token_123',
  player_username: 'player123',
  currency: 'INR',
  platform: 'desktop',
  ip_address: '192.168.1.1'
});
```

### Creating a Transaction
```javascript
const { PlayWin6Transaction } = require('../models');

const transaction = await PlayWin6Transaction.create({
  user_id: 123,
  session_id: session.id,
  type: 'bet',
  amount: 100.00,
  currency: 'INR',
  provider: 'JiliGaming',
  game_id: 'slot_game_001',
  provider_tx_id: 'playwin6_tx_123',
  operator_tx_id: 'internal_tx_456',
  action: 'bet',
  old_balance: 1000.00,
  new_balance: 900.00,
  status: 'completed'
});
```

### Querying Sessions
```javascript
// Get active sessions for a user
const activeSessions = await PlayWin6GameSession.findAll({
  where: {
    user_id: 123,
    status: 'active'
  },
  include: ['user', 'transactions']
});

// Get session by launch token
const session = await PlayWin6GameSession.findOne({
  where: { launch_token: 'unique_launch_token_123' }
});
```

### Querying Transactions
```javascript
// Get user's transaction history
const transactions = await PlayWin6Transaction.findAll({
  where: { user_id: 123 },
  include: ['user', 'session'],
  order: [['created_at', 'DESC']]
});

// Get transactions by type
const bets = await PlayWin6Transaction.findAll({
  where: { type: 'bet', status: 'completed' }
});
```

## üîç Verification Commands

After setting up the tables, verify they were created correctly:

```sql
-- Check if tables exist
SHOW TABLES LIKE 'playwin6%';

-- Check table structure
DESCRIBE playwin6_game_sessions;
DESCRIBE playwin6_transactions;

-- Check indexes
SHOW INDEX FROM playwin6_game_sessions;
SHOW INDEX FROM playwin6_transactions;

-- Check foreign key constraints
SELECT 
    TABLE_NAME,
    COLUMN_NAME,
    CONSTRAINT_NAME,
    REFERENCED_TABLE_NAME,
    REFERENCED_COLUMN_NAME
FROM 
    INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE 
    TABLE_SCHEMA = DATABASE()
    AND TABLE_NAME IN ('playwin6_game_sessions', 'playwin6_transactions')
    AND REFERENCED_TABLE_NAME IS NOT NULL;
```

## üìù Notes

1. **Foreign Key Constraints**: Both tables have CASCADE delete constraints
2. **Indexes**: Comprehensive indexing for optimal query performance
3. **Data Types**: Uses appropriate MySQL data types for each field
4. **Comments**: All fields have descriptive comments for documentation
5. **Timestamps**: Automatic timestamp management for created_at and updated_at
6. **JSON Support**: Uses JSON data type for flexible metadata storage
7. **Enum Constraints**: Proper enum constraints for status and type fields

## üö® Important Considerations

1. **Backup**: Always backup your database before running migrations
2. **Testing**: Test the migration in a development environment first
3. **Performance**: Monitor query performance after creating indexes
4. **Data Integrity**: Foreign key constraints ensure data integrity
5. **Rollback**: The migration includes rollback functionality if needed

## üìû Support

If you encounter any issues with the model setup or database creation:
1. Check the migration logs for detailed error messages
2. Verify your MySQL version supports all data types used
3. Ensure you have proper permissions to create tables and indexes
4. Review the foreign key constraints and ensure referenced tables exist 